<!DOCTYPE html>
<html>

<head>
    <title>HomeOrg</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <div class="container">
        <header>
            <div class="header-navigation"> <div id="back-button" style="display: none;">
                    <i class="material-icons">arrow_back</i>
                </div>
                <div id="home-button" style="display: none; cursor: pointer;">
                    <i class="material-icons">home</i>
                </div>
            </div>
            <span id="header-title">HomeOrg</span>  <div class="header-icons">
                <div class="search-icon">
                    <i class="material-icons">search</i>
                </div>
                <div class="filter-icon">
                    <i class="material-icons">filter_list</i>
                </div>
                <i class="material-icons">more_vert</i>
            </div>
        </header>

        <div class="counts">
            <span>Folders: <span id="folder-count">0</span></span>
            <span>Items: <span id="item-count">0</span></span>
            <span>Quantity: <span id="total-quantity">0</span></span>
        </div>

        <div id="items-grid">
            <div id="folder-grid"></div>
            <div id="item-grid"></div>
        </div>

        <div id="item-details-view" style="display: none;">
            <header>
                <div id="item-details-back-button">
                    <i class="material-icons">arrow_back</i>
                </div>
                <span id="item-details-title"></span>
                <div class="header-icons">
                    <i class="material-icons">more_vert</i>
                </div>
            </header>
            <div id="item-details-content">
                <img id="item-details-image" src="" alt="Item Image" class="thumbnail">
                <div id="item-details-quantity"></div>
                <div id="item-details-date"></div>
                <div id="item-details-tags"></div>
                <div id="item-details-notes"></div>
            </div>
        </div>

        <button id="add-item-fab">
            <i class="material-icons">add</i>
        </button>
    </div>

    <nav class="bottom-nav">
        <a href="#">
            <i class="material-icons">home</i> Items
        </a>
        <a href="#">
            <i class="material-icons">search</i> Search
        </a>
        <a href="#">
            <i class="material-icons">menu</i> Menu
        </a>
    </nav>

    <script>
        let currentFolderId = null; // Track the current folder ID

        function updateCounts(totalQuantity) {
            let url = '/folders/count';
            if (currentFolderId) {
                url = `/folders/${currentFolderId}/count`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('folder-count').textContent = data;
                })
                .catch(error => console.error('Error fetching folder count:', error));

            let itemsUrl = '/items/count';
            if (currentFolderId) {
                itemsUrl = `/folders/${currentFolderId}/items/count`;
            }

            fetch(itemsUrl)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('item-count').textContent = data;
                })
                .catch(error => console.error('Error fetching item count:', error));

            // Update total quantity if provided
            if (totalQuantity !== undefined) {
                document.getElementById('total-quantity').textContent = totalQuantity;
            }
        }

        function displayItems(items) {
            const itemGrid = document.getElementById('item-grid');
            itemGrid.innerHTML = '';

            items.forEach(item => {
                if (item.folder_id === currentFolderId || (currentFolderId === null && item.folder_id === null)) {
                    const itemCard = document.createElement('div');
                    itemCard.className = 'item-card';

                    const imageUrl = item.image_url || 'https://via.placeholder.com/80';

                    itemCard.innerHTML = `
                        <img src="${imageUrl}" alt="${item.name}" class="thumbnail">
                        <div class="item-details">
                            <h3 class="item-title">${item.name}</h3>
                            <div class="item-info">
                                ${item.quantity} ${item.unit}
                            </div>
                        </div>
                        <div class="item-actions">
                            <i class="material-icons">more_vert</i>
                        </div>
                    `;

                    itemCard.addEventListener('click', () => {
                        displayItemDetails(item);
                    });

                    itemGrid.appendChild(itemCard);
                }
            });
        }

        document.getElementById('item-details-back-button').addEventListener('click', () => {
            document.getElementById('item-details-view').style.display = 'none';
            document.getElementById('items-grid').style.display = 'block';
            document.querySelector('.counts').style.display = 'block'; // Show the counts div
            if(currentFolderId){
                document.getElementById('back-button').style.display = 'block';
            }

        });

        function displayItemDetails(item) {
            document.getElementById('item-details-title').textContent = item.name;
            document.getElementById('item-details-image').src = item.image_url || 'https://via.placeholder.com/80';
            document.getElementById('item-details-quantity').textContent = `Quantity: ${item.quantity} ${item.unit}`;
            document.getElementById('item-details-date').textContent = `Date Acquired: ${item.date_acquired || 'N/A'}`;
            document.getElementById('item-details-tags').textContent = `Tags: ${item.tags || 'N/A'}`;
            document.getElementById('item-details-notes').textContent = `Notes: ${item.notes || 'N/A'}`;

            document.getElementById('items-grid').style.display = 'none';
            document.getElementById('item-details-view').style.display = 'block';
            document.getElementById('back-button').style.display = 'none';
            document.querySelector('.counts').style.display = 'none'; // Hide the counts div
        }

        function displayFolders(folders) {
            const folderGrid = document.getElementById('folder-grid');
            folderGrid.innerHTML = ''; // Clear the folder grid

            // Sort folders alphabetically by name
            const sortedFolders = folders.slice().sort((a, b) => {
                const nameA = a.name.toUpperCase();
                const nameB = b.name.toUpperCase();
                if (nameA < nameB) {
                    return -1;
                }
                if (nameA > nameB) {
                    return 1;
                }
                return 0;
            });

            // Array to store promises for all fetch operations
            const fetchPromises = [];

            // First, fetch data for all folders
            sortedFolders.forEach(folder => {
                if (folder.parent_id === currentFolderId || (currentFolderId === null && folder.parent_id === null)) {
                    // Create promises for fetching subfolder count and item count
                    const subfolderCountPromise = fetch(`/folders/${folder.id}/count`).then(response => response.json());
                    const itemCountPromise = fetch(`/folders/${folder.id}/items/count`).then(response => response.json());

                    // Add a promise that resolves with the folder data after both fetches complete
                    const allDataPromise = Promise.all([subfolderCountPromise, itemCountPromise])
                        .then(([subfolderCount, itemCount]) => ({
                            folder,
                            subfolderCount,
                            itemCount
                        }));

                    fetchPromises.push(allDataPromise);
                }
            });

            // After all data is fetched, create and append the folder cards
            Promise.all(fetchPromises)
                .then(folderDataArray => {
                    folderDataArray.forEach(({ folder, subfolderCount, itemCount }) => {
                        const folderCard = document.createElement('div');
                        folderCard.className = 'folder-card';

                        const imageUrl = folder.image_url || 'https://via.placeholder.com/80';

                        let folderInfoHTML = '';
                        if (subfolderCount > 0) {
                            folderInfoHTML += `<i class="material-icons folder-icon">folder</i> ${subfolderCount} | `;
                        }
                        // Display "Items 0" if there are no items
                        folderInfoHTML += `Items ${itemCount > 0 ? itemCount : 0}`;

                        folderCard.innerHTML = `
                            <img src="${imageUrl}" alt="${folder.name}" class="thumbnail">
                            <div class="folder-details">
                                <h3 class="folder-title">${folder.name}</h3>
                                <div class="folder-info">
                                    ${folderInfoHTML}
                                </div>
                            </div>
                            <div class="folder-actions">
                                <i class="material-icons">more_vert</i>
                            </div>
                        `;

                        folderCard.addEventListener('click', () => {
                            currentFolderId = folder.id;
                            loadFolderView();
                        });

                        folderGrid.appendChild(folderCard); // Append after all data is ready
                    });
                })
                .catch(error => console.error('Error fetching folder data:', error));
        }

        function loadRootView() {
            currentFolderId = null;
            document.getElementById('back-button').style.display = 'none';
            document.getElementById('home-button').style.display = 'none'; // Hide home button on root
            document.getElementById('header-title').textContent = "HomeOrg";

            Promise.all([
                fetch('/folders/').then(response => response.json()),
                fetch('/items/').then(response => response.json())
            ])
                .then(([folderData, items]) => {
                    displayFolders(folderData.folders);
                    displayItems(items);
                    updateCounts(folderData.total_quantity); // Pass the total quantity

                    // Update the total quantity display
                    document.getElementById('total-quantity').textContent = folderData.total_quantity;
                })
                .catch(error => console.error('Error loading root view:', error));
        }

        function loadFolderView() {
            document.getElementById('back-button').style.display = 'block';
            document.getElementById('home-button').style.display = 'block'; // Show home button when in a folder

            fetch(`/folders/${currentFolderId}`)
                .then(response => response.json())
                .then(folder => {
                    document.getElementById('header-title').textContent = folder.name; // Ensure this line exists

                    Promise.all([
                        fetch(`/folders/${currentFolderId}/folders`).then(response => response.json()),
                        fetch(`/folders/${currentFolderId}/items`).then(response => response.json()),
                        fetch(`/folders/${currentFolderId}/quantity`).then(response => response.json())
                    ])
                        .then(([subFolders, items, quantityData]) => {
                            document.getElementById('folder-grid').innerHTML = '';
                            document.getElementById('item-grid').innerHTML = '';
                            displayFolders(subFolders);
                            displayItems(items);
                            updateCounts(quantityData.quantity);
                        })
                        .catch(error => console.error(`Error loading folder view for ${currentFolderId}:`, error));
                })
                .catch(error => console.error(`Error fetching folder details for ${currentFolderId}:`, error));
        }

        document.getElementById('back-button').addEventListener('click', () => {
            if (currentFolderId) {
                fetch(`/folders/${currentFolderId}/parent`)
                    .then(response => response.json())
                    .then(data => {
                        if (data) {
                            currentFolderId = data.id;
                            loadFolderView();
                        } else {
                            loadRootView();
                        }
                    })
                    .catch(error => console.error(`Error fetching parent folder for ${currentFolderId}:`, error));
            }
        });

        // New event listener for the home button
        document.getElementById('home-button').addEventListener('click', () => {
            loadRootView(); // Call loadRootView to go to the root level
        });

        loadRootView(); // Load root view on page load
    </script>
</body>

</html>